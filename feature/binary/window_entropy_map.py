import numpy as np


class WindowEntropyMap:
    def __init__(self, window_size=2048, stride=1024, map_size=16):
        self.window_size = window_size
        self.stride = stride
        self.map_size = map_size

        self.row_cut = np.round(8.1 / self.map_size, 4)

        self.entropy_matrix = None

    def fit(self, path):
        with open(path, "rb") as file_descriptor:
            byte_sequence = list(file_descriptor.read())

        entropy_list, histogram_list = self._slide_window(byte_sequence)
        self.entropy_matrix = self._map_values(entropy_list, histogram_list)

    def _slide_window(self, byte_sequence):
        entropy_list = list()
        histogram_list = list()

        for index in range(0, len(byte_sequence) - self.window_size + 1, self.stride):
            subsequence = byte_sequence[index: index + self.window_size]

            byte_histogram = np.array([subsequence.count(byte_value) for byte_value in range(0, 256)])
            byte_frequency = (byte_histogram / float(len(subsequence))) + 1e-10

            entropy = self.get_entropy(byte_frequency)
            byte_histogram = np.sum(byte_histogram.reshape(self.map_size, -1), axis=1)

            entropy_list.append(entropy)
            histogram_list.append(byte_histogram)

        return entropy_list, histogram_list

    @staticmethod
    def get_entropy(byte_frequency):
        return -np.sum(np.log(byte_frequency) * byte_frequency)

    def _map_values(self, entropy_list, histogram_list):
        entropy_matrix = np.zeros((self.map_size, self.map_size), dtype=int)

        for entropy, byte_histogram in zip(entropy_list, histogram_list):
            row_index = int(entropy / self.row_cut)

            entropy_matrix[row_index, :] += byte_histogram

        return entropy_matrix

    def get_string(self):
        if self.entropy_matrix is None:
            return None

        features = list()
        for index, value in enumerate(self.entropy_matrix.reshape(-1)):
            features.append("{0}:{1}".format(index, value))

        return features
